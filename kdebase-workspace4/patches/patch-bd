$NetBSD$

--- ksysguard/ksysguardd/NetBSD/Memory.c.orig	2006-10-26 15:12:41.000000000 +1300
+++ ksysguard/ksysguardd/NetBSD/Memory.c
@@ -21,7 +21,6 @@
 */
 
 #include <fcntl.h>
-#include <kvm.h>
 #include <limits.h>
 #include <stdio.h>
 #include <stdlib.h>
@@ -45,37 +44,42 @@
 static size_t Total = 0;
 static size_t MFree = 0;
 static size_t Used = 0;
-static size_t Buffers = 0;
-static size_t Cached = 0;
+static size_t Active = 0;
+static size_t Inactive = 0;
+static size_t Wired = 0;
+static size_t Execpages = 0;
+static size_t Filepages = 0;
+static size_t Anonpages = 0;
 static size_t STotal = 0;
 static size_t SFree = 0;
 static size_t SUsed = 0;
-static kvm_t *kd;
+
+static size_t Appl = 0;
 
 void
 initMemory(struct SensorModul* sm)
 {
-	char *nlistf = NULL;
-	char *memf = NULL;
-	char buf[_POSIX2_LINE_MAX];
-	
-	if ((kd = kvm_openfiles(nlistf, memf, NULL, O_RDONLY, buf)) == NULL) {
-		log_error("kvm_openfiles()");
-		return;
-	}
-
         registerMonitor("mem/physical/free", "integer", printMFree, printMFreeInfo, sm);
 	registerMonitor("mem/physical/used", "integer", printUsed, printUsedInfo, sm);
-	registerMonitor("mem/physical/buf", "integer", printBuffers, printBuffersInfo, sm);
-	registerMonitor("mem/physical/cached", "integer", printCached, printCachedInfo, sm);
+	registerMonitor("mem/physical/active", "integer", printActive, printActiveInfo, sm);
+	registerMonitor("mem/physical/inactive", "integer", printInactive, printInactiveInfo, sm);
+	registerMonitor("mem/physical/wired", "integer", printWired, printWiredInfo, sm);
+	registerMonitor("mem/physical/execpages", "integer", printExecpages, printExecpagesInfo, sm);
+	registerMonitor("mem/physical/filepages", "integer", printFilepages, printFilepagesInfo, sm);
+	registerMonitor("mem/physical/anonpages", "integer", printAnonpages, printAnonpagesInfo, sm);
 	registerMonitor("mem/swap/free", "integer", printSwapFree, printSwapFreeInfo, sm);
 	registerMonitor("mem/swap/used", "integer", printSwapUsed, printSwapUsedInfo, sm);
+
+
+	/* Linux compat */
+	registerMonitor( "mem/physical/application", "integer", printAppl, printApplInfo, sm );
+	registerMonitor( "mem/physical/buf", "integer", printBuffers, printBuffersInfo, sm );
+	registerMonitor( "mem/physical/cached", "integer", printCached, printCachedInfo, sm );
 }
 
 void
 exitMemory(void)
 {
-	kvm_close(kd);
 }
 
 int
@@ -83,7 +87,6 @@ updateMemory(void)
 {
 
 #define ARRLEN(X) (sizeof(X)/sizeof(X[0]))
-  long pagesize; /* using a long promotes the arithmetic */
   size_t len;
   
   {
@@ -95,35 +98,26 @@ updateMemory(void)
   }
  
   {
-    struct uvmexp x;
-    static int mib[] = { CTL_VM, VM_UVMEXP };
+    struct uvmexp_sysctl x;
+    static int mib[] = { CTL_VM, VM_UVMEXP2 };
     
     len = sizeof(x);
     STotal = SUsed = SFree = -1;
-    pagesize = 1;
+    Active = Inactive = Wired = Execpages = Filepages = Anonpages = -1;
+    MFree = Used = -1;
     if (-1 < sysctl(mib, ARRLEN(mib), &x, &len, NULL, 0)) {
-      pagesize = x.pagesize;
-      STotal = (pagesize*x.swpages) >> 10;
-      SUsed = (pagesize*x.swpginuse) >> 10;
+      STotal = (x.pagesize*x.swpages) >> 10;
+      SUsed = (x.pagesize*x.swpginuse) >> 10;
       SFree = STotal - SUsed;
-    }
-  }
- 
-  /* can't find NetBSD file system buffer info */
-  Buffers = -1;
- 
-  /* NetBSD doesn't know about vm.stats */
-  Cached = -1;
-  
-  {
-    static int mib[]={ CTL_VM, VM_METER };
-    struct vmtotal x;
-    
-    len = sizeof(x);
-    MFree = Used = -1;
-    if (sysctl(mib, ARRLEN(mib), &x, &len, NULL, 0) > -1) {
-      MFree = (x.t_free * pagesize) >> 10;
-      Used = (x.t_rm * pagesize) >> 10;
+      MFree = (x.free * x.pagesize) >> 10;
+      Active = (x.active * x.pagesize) >> 10;
+      Inactive = (x.inactive * x.pagesize) >> 10;
+      Wired = (x.wired * x.pagesize) >> 10;
+      Execpages = (x.execpages * x.pagesize) >> 10;
+      Filepages = (x.filepages * x.pagesize) >> 10;
+      Anonpages = (x.anonpages * x.pagesize) >> 10;
+      Used = Total - MFree;
+      Appl = Active - Filepages;
     }
   }
   return 0;
@@ -154,27 +148,75 @@ printUsedInfo(const char* cmd)
 }
 
 void
-printBuffers(const char* cmd)
+printActive(const char* cmd)
 {
-	fprintf(CurrentClient, "%d\n", Buffers);
+	fprintf(CurrentClient, "%d\n", Active);
 }
 
 void
-printBuffersInfo(const char* cmd)
+printActiveInfo(const char* cmd)
 {
-	fprintf(CurrentClient, "Buffer Memory\t0\t%d\tKB\n", Total);
+	fprintf(CurrentClient, "Active Memory\t0\t%d\tKB\n", Total);
 }
 
 void
-printCached(const char* cmd)
+printInactive(const char* cmd)
 {
-	fprintf(CurrentClient, "%d\n", Cached);
+	fprintf(CurrentClient, "%d\n", Inactive);
 }
 
 void
-printCachedInfo(const char* cmd)
+printInactiveInfo(const char* cmd)
 {
-	fprintf(CurrentClient, "Cached Memory\t0\t%d\tKB\n", Total);
+	fprintf(CurrentClient, "Inactive Memory\t0\t%d\tKB\n", Total);
+}
+
+void
+printWired(const char* cmd)
+{
+	fprintf(CurrentClient, "%d\n", Wired);
+}
+
+void
+printWiredInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Wired Memory\t0\t%d\tKB\n", Total);
+}
+
+void
+printExecpages(const char* cmd)
+{
+	fprintf(CurrentClient, "%d\n", Execpages);
+}
+
+void
+printExecpagesInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Exec Pages\t0\t%d\tKB\n", Total);
+}
+
+void
+printFilepages(const char* cmd)
+{
+	fprintf(CurrentClient, "%d\n", Filepages);
+}
+
+void
+printFilepagesInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "File Pages\t0\t%d\tKB\n", Total);
+}
+
+void
+printAnonpages(const char* cmd)
+{
+	fprintf(CurrentClient, "%d\n", Anonpages);
+}
+
+void
+printAnonpagesInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Anon Pages\t0\t%d\tKB\n", Total);
 }
 
 void
@@ -200,3 +242,40 @@ printSwapFreeInfo(const char* cmd)
 {
 	fprintf(CurrentClient, "Free Swap Memory\t0\t%d\tKB\n", STotal);
 }
+
+/* Linux compat */
+void
+printBuffers(const char* cmd)
+{
+  fprintf(CurrentClient, "%d\n", Filepages /* + bufmem */);
+}
+
+void
+printBuffersInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Buffer Memory\t0\t%d\tKB\n", Total);
+}
+
+void
+printCached(const char* cmd)
+{
+	fprintf(CurrentClient, "0\n");
+}
+
+void
+printCachedInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Cached Memory\t0\t%d\tKB\n", Total);
+}
+
+void
+printAppl(const char* cmd)
+{
+	fprintf(CurrentClient, "%d\n", Appl);
+}
+
+void
+printApplInfo(const char* cmd)
+{
+	fprintf(CurrentClient, "Application Memory\t0\t%d\tKB\n", Total);
+}
