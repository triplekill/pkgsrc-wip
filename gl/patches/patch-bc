$NetBSD$

--- src/mesa/drivers/dri/r300/compiler/Makefile.orig	2009-12-22 02:26:02.000000000 +0000
+++ src/mesa/drivers/dri/r300/compiler/Makefile
@@ -45,10 +45,12 @@ INCLUDES = \
 
 ##### TARGETS #####
 
-default: depend lib$(LIBNAME).a
+default: depend lib$(LIBNAME).la
 
-lib$(LIBNAME).a: $(OBJECTS) Makefile $(TOP)/configs/current
+lib$(LIBNAME).la: $(OBJECTS) Makefile $(TOP)/configs/current
 	$(MKLIB) -o $(LIBNAME) -static $(OBJECTS)
+	$(LIBTOOL) --mode=link $(CC) -o $@ $(OBJECTS:.o=.lo) \
+		-static -avoid-version
 
 depend: $(C_SOURCES) $(CPP_SOURCES) $(ASM_SOURCES) $(SYMLINKS)
 	rm -f depend
@@ -61,7 +63,7 @@ tags:
 
 # Remove .o and backup files
 clean:
-	rm -f $(OBJECTS) lib$(LIBNAME).a depend depend.bak
+	rm -f $(OBJECTS) lib$(LIBNAME).la depend depend.bak
 
 # Dummy target
 install:
@@ -70,13 +72,16 @@ install:
 ##### RULES #####
 
 .c.o:
-	$(CC) -c $(INCLUDES) $(CFLAGS) $(LIBRARY_DEFINES) $< -o $@
+	$(LIBTOOL) --mode=compile --tag=CC \
+		$(CC) -c $(INCLUDE) $(CFLAGS) $(COPTS) $(LIBRARY_DEFINES) $< -o $(@:.o=.lo)
 
 .cpp.o:
-	$(CXX) -c $(INCLUDES) $(CXXFLAGS) $(LIBRARY_DEFINES) $< -o $@
+	$(LIBTOOL) --mode=compile --tag=CXX \
+		$(CXX) -c $(INCLUDE) $(CXXFLAGS) $(LIBRARY_DEFINES) $< -o $(@:.o=.lo)
 
 .S.o:
-	$(CC) -c $(INCLUDES) $(CFLAGS) $(LIBRARY_DEFINES)  $< -o $@
+	$(LIBTOOL) --mode=compile --tag=CC \
+		$(CC) -c $(INCLUDE) $(CFLAGS) $(LIBRARY_DEFINES) $< -o $(@:.o=.lo)
 
 
 sinclude depend
