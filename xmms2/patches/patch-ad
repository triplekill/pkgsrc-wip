$NetBSD$

--- src/plugins/flac/flac.c.orig	2006-09-26 13:50:20.000000000 +0000
+++ src/plugins/flac/flac.c
@@ -26,8 +26,26 @@
 
 #include <glib.h>
 
+#if !defined(FLAC_API_VERSION_CURRENT) || FLAC_API_VERSION_CURRENT <= 7
+# define FLAC__STREAM_DECODER_WRITE_STATUS_CONTINUE FLAC__SEEKABLE_STREAM_DECODER_WRITE_STATUS_CONTINUE
+# define FLAC__SEEKABLE_STREAM_DECODER_SEEK_STATUS_OK FLAC__STREAM_DECODER_SEEK_STATUS_OK
+# define FLAC__SEEKABLE_STREAM_DECODER_SEEK_STATUS_ERROR FLAC__STREAM_DECODER_SEEK_STATUS_ERROR
+# define FLAC__SEEKABLE_STREAM_DECODER_TELL_STATUS_OK FLAC__STREAM_DECODER_TELL_STATUS_OK
+# define FLAC__SEEKABLE_STREAM_DECODER_TELL_STATUS_ERROR FLAC__STREAM_DECODER_TELL_STATUS_ERROR
+# define FLAC__SEEKABLE_STREAM_DECODER_LENGTH_STATUS_OK FLAC__STREAM_DECODER_LENGTH_STATUS_OK
+# define FLAC__SEEKABLE_STREAM_DECODER_LENGTH_STATUS_ERROR FLAC__STREAM_DECODER_LENGTH_STATUS_ERROR
+# define FLAC__SEEKABLE_STREAM_DECODER_END_OF_STREAM FLAC__STREAM_DECODER_END_OF_STREAM
+# define FLAC__StreamDecoder FLAC__SeekableStreamDecoder
+# define FLAC__SeekableStreamDecoderState FLAC_StreamDecoderState
+# define FLAC__seekable_stream_decoder_finish FLAC__stream_decoder_finish
+# define FLAC__seekable_stream_decoder_delete FLAC__stream_decoder_delete
+# define FLAC__seekable_stream_decoder_process_single FLAC__stream_decoder_process_single
+# define FLAC__seekable_stream_decoder_get_state FLAC__stream_decoder_get_state
+# define FLAC__seekable_stream_decoder_seek_absolute FLAC__stream_decoder_seek_absolute
+#endif
+
 typedef struct xmms_flac_data_St {
-	FLAC__SeekableStreamDecoder *flacdecoder;
+	FLAC__StreamDecoder *flacdecoder;
 	FLAC__StreamMetadata *vorbiscomment;
 	guint channels;
 	guint sample_rate;
@@ -83,8 +101,8 @@ xmms_flac_plugin_setup (xmms_xform_plugi
 	return TRUE;
 }
 
-static FLAC__SeekableStreamDecoderReadStatus
-flac_callback_read (const FLAC__SeekableStreamDecoder *flacdecoder,
+static FLAC__StreamDecoderReadStatus
+flac_callback_read (const FLAC__StreamDecoder *flacdecoder,
                     FLAC__byte buffer[],
                     guint *bytes,
                     void *client_data)
@@ -94,17 +112,26 @@ flac_callback_read (const FLAC__Seekable
 	gint ret;
 
 	g_return_val_if_fail (xform,
+#if !defined(FLAC_API_VERSION_CURRENT) || FLAC_API_VERSION_CURRENT <= 7
 	                      FLAC__SEEKABLE_STREAM_DECODER_READ_STATUS_ERROR);
+#else
+	                      FLAC__STREAM_DECODER_READ_STATUS_ABORT);
+#endif
 
 	ret = xmms_xform_read (xform, (gchar *)buffer, *bytes, &error);
 	*bytes = ret;
 
+#if !defined(FLAC_API_VERSION_CURRENT) || FLAC_API_VERSION_CURRENT <= 7
 	return (ret <= 0) ? FLAC__SEEKABLE_STREAM_DECODER_READ_STATUS_ERROR
 	                  : FLAC__SEEKABLE_STREAM_DECODER_READ_STATUS_OK;
+#else
+	return (ret <= 0) ? FLAC__STREAM_DECODER_READ_STATUS_END_OF_STREAM
+	                  : FLAC__STREAM_DECODER_READ_STATUS_CONTINUE;
+#endif
 }
 
 static FLAC__StreamDecoderWriteStatus
-flac_callback_write (const FLAC__SeekableStreamDecoder *flacdecoder,
+flac_callback_write (const FLAC__StreamDecoder *flacdecoder,
                      const FLAC__Frame *frame,
                      const FLAC__int32 * const buffer[],
                      void *client_data)
@@ -139,25 +166,25 @@ flac_callback_write (const FLAC__Seekabl
 	return FLAC__STREAM_DECODER_WRITE_STATUS_CONTINUE;
 }
 
-static FLAC__SeekableStreamDecoderTellStatus
-flac_callback_tell (const FLAC__SeekableStreamDecoder *flacdecoder,
+static FLAC__StreamDecoderTellStatus
+flac_callback_tell (const FLAC__StreamDecoder *flacdecoder,
                     FLAC__uint64 *offset, void *client_data)
 {
 	xmms_error_t err;
 	xmms_xform_t *xform = (xmms_xform_t *) client_data;
 
 	g_return_val_if_fail (xform,
-	                      FLAC__SEEKABLE_STREAM_DECODER_SEEK_STATUS_ERROR);
+	                      FLAC__STREAM_DECODER_TELL_STATUS_ERROR);
 
 	xmms_error_reset (&err);
 
 	*offset = xmms_xform_seek (xform, 0, XMMS_XFORM_SEEK_CUR, &err);
 
-	return FLAC__SEEKABLE_STREAM_DECODER_TELL_STATUS_OK;
+	return FLAC__STREAM_DECODER_TELL_STATUS_OK;
 }
 
-static FLAC__SeekableStreamDecoderSeekStatus
-flac_callback_seek (const FLAC__SeekableStreamDecoder *flacdecoder,
+static FLAC__StreamDecoderSeekStatus
+flac_callback_seek (const FLAC__StreamDecoder *flacdecoder,
                     FLAC__uint64 offset, void *client_data)
 {
 	xmms_error_t err;
@@ -169,12 +196,12 @@ flac_callback_seek (const FLAC__Seekable
 	retval = xmms_xform_seek (xform, (gint64) offset,
 	                          XMMS_XFORM_SEEK_SET, &err);
 
-	return (retval == -1) ? FLAC__SEEKABLE_STREAM_DECODER_SEEK_STATUS_ERROR
-	                      : FLAC__SEEKABLE_STREAM_DECODER_SEEK_STATUS_OK;
+	return (retval == -1) ? FLAC__STREAM_DECODER_SEEK_STATUS_ERROR
+	                      : FLAC__STREAM_DECODER_SEEK_STATUS_OK;
 }
 
-static FLAC__SeekableStreamDecoderLengthStatus
-flac_callback_length (const FLAC__SeekableStreamDecoder *flacdecoder,
+static FLAC__StreamDecoderLengthStatus
+flac_callback_length (const FLAC__StreamDecoder *flacdecoder,
                       FLAC__uint64 *stream_length, void *client_data)
 {
 	xmms_xform_t *xform = (xmms_xform_t *) client_data;
@@ -184,12 +211,12 @@ flac_callback_length (const FLAC__Seekab
 										  XMMS_MEDIALIB_ENTRY_PROPERTY_SIZE);
 	*stream_length = retval;
 
-	return (retval == -1) ? FLAC__SEEKABLE_STREAM_DECODER_LENGTH_STATUS_ERROR
-	                      : FLAC__SEEKABLE_STREAM_DECODER_LENGTH_STATUS_OK;
+	return (retval == -1) ? FLAC__STREAM_DECODER_LENGTH_STATUS_ERROR
+	                      : FLAC__STREAM_DECODER_LENGTH_STATUS_OK;
 }
 
 static void
-flac_callback_metadata (const FLAC__SeekableStreamDecoder *flacdecoder,
+flac_callback_metadata (const FLAC__StreamDecoder *flacdecoder,
                         const FLAC__StreamMetadata *metadata,
                         void *client_data)
 {
@@ -233,7 +260,7 @@ flac_callback_metadata (const FLAC__Seek
 }
 
 static FLAC__bool
-flac_callback_eof (const FLAC__SeekableStreamDecoder *flacdecoder,
+flac_callback_eof (const FLAC__StreamDecoder *flacdecoder,
                    void *client_data)
 {
 	xmms_xform_t *xform = (xmms_xform_t *) client_data;
@@ -245,7 +272,7 @@ flac_callback_eof (const FLAC__SeekableS
 }
 
 static void
-flac_callback_error (const FLAC__SeekableStreamDecoder *flacdecoder,
+flac_callback_error (const FLAC__StreamDecoder *flacdecoder,
                      FLAC__StreamDecoderErrorStatus status,
                      void *client_data)
 {
@@ -291,7 +318,11 @@ xmms_flac_init (xmms_xform_t *xform)
 	xmms_flac_data_t *data;
 	xmms_sample_format_t sample_fmt;
 	FLAC__bool retval;
-	FLAC__SeekableStreamDecoderState init_status;
+#if !defined(FLAC_API_VERSION_CURRENT) || FLAC_API_VERSION_CURRENT <= 7
+	FLAC__StreamDecoderState init_status;
+#else
+	FLAC__StreamDecoderInitStatus init_status;
+#endif
 	gint current, num_comments;
 	gint filesize;
 
@@ -299,6 +330,7 @@ xmms_flac_init (xmms_xform_t *xform)
 
 	data = g_new0 (xmms_flac_data_t, 1);
 
+#if !defined(FLAC_API_VERSION_CURRENT) || FLAC_API_VERSION_CURRENT <= 7
 	data->flacdecoder = FLAC__seekable_stream_decoder_new ();
 	FLAC__seekable_stream_decoder_set_eof_callback (data->flacdecoder,
 	                                                flac_callback_eof);
@@ -318,9 +350,6 @@ xmms_flac_init (xmms_xform_t *xform)
 	                                                     flac_callback_metadata);
 
 	FLAC__seekable_stream_decoder_set_client_data (data->flacdecoder, xform);
-
-	xmms_xform_private_data_set (xform, data);
-
 	FLAC__seekable_stream_decoder_set_metadata_respond_all (data->flacdecoder);
 
 	init_status = FLAC__seekable_stream_decoder_init (data->flacdecoder);
@@ -334,6 +363,35 @@ xmms_flac_init (xmms_xform_t *xform)
 	retval = FLAC__seekable_stream_decoder_process_until_end_of_metadata (data->flacdecoder);
 	if (!retval)
 		goto err;
+#else
+	data->flacdecoder = FLAC__stream_decoder_new ();
+
+	init_status =
+		FLAC__stream_decoder_init_stream (data->flacdecoder,
+		                                  flac_callback_read,
+		                                  flac_callback_seek,
+		                                  flac_callback_tell,
+		                                  flac_callback_length,
+		                                  flac_callback_eof,
+		                                  flac_callback_write,
+		                                  flac_callback_metadata,
+		                                  flac_callback_error,
+		                                  xform);
+
+	if (init_status != FLAC__STREAM_DECODER_INIT_STATUS_OK) {
+		XMMS_DBG ("FLAC init failed: %s",
+		          FLAC__stream_decoder_get_resolved_state_string (data->flacdecoder));
+		goto err;
+	}
+
+	FLAC__stream_decoder_set_metadata_respond_all (data->flacdecoder);
+
+	retval = FLAC__stream_decoder_process_until_end_of_metadata (data->flacdecoder);
+	if (!retval)
+		goto err;
+#endif
+
+	xmms_xform_private_data_set (xform, data);
 
 	if (data->vorbiscomment) {
 		num_comments = data->vorbiscomment->data.vorbis_comment.num_comments;
@@ -422,8 +480,8 @@ xmms_flac_init (xmms_xform_t *xform)
 
 err:
 
-	FLAC__seekable_stream_decoder_finish (data->flacdecoder);
-	FLAC__seekable_stream_decoder_delete (data->flacdecoder);
+	FLAC__stream_decoder_finish (data->flacdecoder);
+	FLAC__stream_decoder_delete (data->flacdecoder);
 	g_free (data);
 
 	return FALSE;
@@ -434,7 +492,7 @@ static gint
 xmms_flac_read (xmms_xform_t *xform, xmms_sample_t *buf, gint len,
                 xmms_error_t *err)
 {
-	FLAC__SeekableStreamDecoderState state;
+	FLAC__StreamDecoderState state;
 	xmms_flac_data_t *data;
 	gboolean ret;
 	guint32 size;
@@ -447,12 +505,12 @@ xmms_flac_read (xmms_xform_t *xform, xmm
 	size = MIN (data->buffer->len, len);
 
 	if (size <= 0) {
-		ret = FLAC__seekable_stream_decoder_process_single (data->flacdecoder);
+		ret = FLAC__stream_decoder_process_single (data->flacdecoder);
 	}
 
-	state = FLAC__seekable_stream_decoder_get_state (data->flacdecoder);
+	state = FLAC__stream_decoder_get_state (data->flacdecoder);
 
-	if (state == FLAC__SEEKABLE_STREAM_DECODER_END_OF_STREAM) {
+	if (state == FLAC__STREAM_DECODER_END_OF_STREAM) {
 		return 0;
 	}
 
@@ -482,8 +540,8 @@ xmms_flac_seek (xmms_xform_t *xform, gin
 		return -1;
 	}
 
-	res = FLAC__seekable_stream_decoder_seek_absolute (data->flacdecoder,
-	                                                   (FLAC__uint64) samples);
+	res = FLAC__stream_decoder_seek_absolute (data->flacdecoder,
+	                                          (FLAC__uint64) samples);
 
 	return res ? samples : -1;
 }
@@ -504,8 +562,8 @@ xmms_flac_destroy (xmms_xform_t *xform)
 
 	g_string_free (data->buffer, TRUE);
 
-	FLAC__seekable_stream_decoder_finish (data->flacdecoder);
-	FLAC__seekable_stream_decoder_delete (data->flacdecoder);
+	FLAC__stream_decoder_finish (data->flacdecoder);
+	FLAC__stream_decoder_delete (data->flacdecoder);
 
 	g_free (data);
 }
