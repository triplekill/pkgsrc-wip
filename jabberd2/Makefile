# $NetBSD$
#

DISTNAME=		jabberd-2.0.0-a5
PKGNAME=		${DISTNAME:S/d-2.0.0-a/d2-2.0rc/}
CATEGORIES=		chat
MASTER_SITES=		http://www.jabberstudio.org/files/jabberd2/

MAINTAINER=		xtraeme@NetBSD.org
HOMEPAGE=		http://www.jabberstudio.org/
COMMENT=		Instant messaging server ( version 2 )

CONFLICTS=		jabberd-[0-9]*:../../wip/jabberd

USE_BUILDLINK2=		yes
USE_LIBTOOL=		yes
GNU_CONFIGURE=		yes
USE_PKGINSTALL=		yes

LIBTOOL_OVERRIDE=       ${WRKSRC}/libtool

.include "../../mk/bsd.prefs.mk"

BUILD_DEFS+=	JABBERD2_USES_PGSQL JABBERD2_USES_MYSQL JABBERD2_USES_PAM

.for F in ${BUILD_DEFS}
${F}?= NO
.endfor
.undef F

.if defined(JABBERD2_USES_PGSQL) && !empty(JABBERD2_USES_PGSQL:M[Yy][Ee][Ss])
CONFIGURE_ARGS+=	--with-pgsql=${BUILDLINK_PREFIX.postgresql-lib}
.include "../../databases/postgresql-lib/buildlink2.mk"
.endif

.if defined(JABBERD2_USES_MYSQL) && !empty(JABBERD2_USES_MYSQL:M[Yy][Ee][Ss])
CONFIGURE_ARGS+=	--with-mysql=${BUILDLINK_PREFIX.mysql-client}
.include "../../databases/mysql-client/buildlink2.mk"
.endif

.if defined(JABBERD2_USES_PAM) && !empty(JABBERD2_USES_PAM:M[Yy][Ee][Ss])
CONFIGURE_ARGS+=	--with-pam=${BUILDLINK_PREFIX.PAM}
.include "../../security/PAM/buildlink2.mk"
.endif

RCD_SCRIPTS=		jabberd
PKG_SYSCONFSUBDIR=	jabberd

JABBERD_USER=           jabberd
JABBERD_GROUP=          jabberd
PKG_GROUPS=             ${JABBERD_GROUP}
PKG_USERS=              ${JABBERD_USER}:${JABBERD_GROUP}::Jabberd\\ user

EGDIR=			${PREFIX}/share/examples/jabberd
SUPPORT_FILES=          ${EGDIR}/jabberd.cfg ${PKG_SYSCONFDIR}/jabberd.cfg

FILES=			c2s.xml resolver.xml router.xml s2s.xml sm.xml

.for f in ${FILES}
CONF_FILES+=		${EGDIR}/${f} ${PKG_SYSCONFDIR}/${f}
.endfor
.undef f

DIRS=			/var/log/jabberd /var/db/jabberd

.for f in ${DIRS}
OWN_DIRS_PERMS+=	${f} jabberd jabberd 750
.endfor
.undef f

post-extract:

.for f in jabberd.cfg ${FILES}
	${MV} ${WRKSRC}/etc/${f}.dist.in ${WRKSRC}/etc/${f}.in
.endfor
.undef f

pre-configure:

.for f in ${FILES}
	${SED}  \
		-e "s|@@PKG_SYSCONFDIR@@|${PKG_SYSCONFDIR}|g" \
		-e "s|@@LOGDIR@@|/var/log/jabberd|g " \
		-e "s|@@BINDIR@@|${PREFIX}/bin|g " \
		-e "s|@@DBDIR@@|/var/db/jabberd|g " \
		< ${WRKSRC}/etc/${f}.in > ${WRKSRC}/etc/${f}
.endfor
.undef f

	${SED}  \
		-e "s|@@PKG_SYSCONFDIR@@|${PKG_SYSCONFDIR}|g" \
		< ${WRKSRC}/etc/jabberd.cfg.in > ${WRKSRC}/etc/jabberd.cfg

post-install:
	${INSTALL_DATA_DIR} ${EGDIR}

.for f in jabberd.cfg ${FILES}
	${INSTALL_DATA} ${WRKSRC}/etc/${f} ${EGDIR}
.endfor

.include "../../converters/libiconv/buildlink2.mk"
.include "../../databases/db4/buildlink2.mk"
.include "../../databases/openldap/buildlink2.mk"
.include "../../security/openssl/buildlink2.mk"
.include "../../security/cyrus-sasl2/buildlink2.mk"
.include "../../mk/bsd.pkg.mk"
