--- block-raw.c.orig	2007-10-07 14:53:58.000000000 +0200
+++ block-raw.c	2007-10-07 14:39:43.000000000 +0200
@@ -25,7 +25,9 @@
 #include "block_int.h"
 #include <assert.h>
 #ifndef _WIN32
+#ifdef _POSIX_ASYNCHRONOUS_IO
 #include <aio.h>
+#endif
 
 #ifndef QEMU_TOOL
 #include "exec-all.h"
@@ -222,6 +224,7 @@
     return ret;
 }
 
+#ifdef _POSIX_ASYNCHRONOUS_IO
 /***********************************************************/
 /* Unix AIO using POSIX AIO */
 
@@ -444,6 +447,7 @@
         pacb = &acb->next;
     }
 }
+#endif
 
 static void raw_close(BlockDriverState *bs)
 {
@@ -534,6 +538,35 @@
     fsync(s->fd);
 }
 
+#ifndef _POSIX_ASYNCHRONOUS_IO
+void qemu_aio_init(void)
+{
+}
+
+void qemu_aio_poll(void)
+{
+}
+
+void qemu_aio_flush(void)
+{
+}
+
+void qemu_aio_wait_start(void)
+{
+}
+
+void qemu_aio_wait(void)
+{
+#ifndef QEMU_TOOL
+    qemu_bh_poll();
+#endif
+}
+
+void qemu_aio_wait_end(void)
+{
+}
+#endif
+
 BlockDriver bdrv_raw = {
     "raw",
     sizeof(BDRVRawState),
@@ -545,10 +578,12 @@
     raw_create,
     raw_flush,
 
+#ifdef _POSIX_ASYNCHRONOUS_IO
     .bdrv_aio_read = raw_aio_read,
     .bdrv_aio_write = raw_aio_write,
     .bdrv_aio_cancel = raw_aio_cancel,
     .aiocb_size = sizeof(RawAIOCB),
+#endif
     .protocol_name = "file",
     .bdrv_pread = raw_pread,
     .bdrv_pwrite = raw_pwrite,
@@ -881,10 +916,12 @@
     NULL,
     raw_flush,
 
+#ifdef _POSIX_ASYNCHRONOUS_IO
     .bdrv_aio_read = raw_aio_read,
     .bdrv_aio_write = raw_aio_write,
     .bdrv_aio_cancel = raw_aio_cancel,
     .aiocb_size = sizeof(RawAIOCB),
+#endif
     .bdrv_pread = raw_pread,
     .bdrv_pwrite = raw_pwrite,
     .bdrv_getlength = raw_getlength,
