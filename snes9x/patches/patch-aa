$NetBSD$

--- Makefile.in.orig	2004-12-30 22:15:44.000000000 +0000
+++ Makefile.in
@@ -59,11 +59,20 @@ C4DEPENDS=c_c4
 C4NO_DEPENDS=zsnes_c4
 endif
 
+ifdef NETBSD_USE_DGA
+DGADEFINES=-DUSE_DGA_EXTENSION -DUSE_VIDMODE_EXTENSION
+DGALIBS=-lXxf86dga -lXxf86vm
+endif
+
 ifdef SPC700ASM
 SOUNDOBJ=spctool/spc700.o spctool/dsp.o spctool.o spctool/soundmod.o @I386SPC@
 SOUNDDEFINES=-DSPCTOOL
 else
+ifdef USING_I386
 SOUNDOBJ=spc700.o soundux.o apu.o @I386SPC@
+else
+SOUNDOBJ=spc700.o soundux.o apu.o
+endif
 SOUNDDEFINES=-DSPC700_C
 endif
 
@@ -100,6 +109,20 @@ KREEDOBJ=2xsai.o
 endif
 endif
 
+ifdef USBJOY
+ifdef USBHID_H
+USBJOYDEFINES=-DJOYSTICK_SUPPORT -DHAVE_USBHID_H
+EXTRALIBS+=-lusbhid
+else
+USBJOYDEFINES=-DJOYSTICK_SUPPORT
+EXTRALIBS+=-lusb
+endif
+endif
+
+ifdef _ASM_UNDERBARS
+EXTRADEFINES+=-D_ASM_UNDERBARS
+endif
+
 ifdef SDD1_DECOMP
 SDD1OBJ=sdd1emu.o
 ifdef SDD1_VERIFY
@@ -136,9 +159,10 @@ OBJECTS += jma/s9x-jma.o jma/7zlzma.o jm
 JMADEFINES=-DJMA_SUPPORT -fexceptions
 endif
 
+EXTRALIBS+=	$(LIBOSSAUDIO)
 ifdef THREAD_SOUND
-CPUDEFINES += -DUSE_THREADS
-EXTRALIBS += -lpthread
+CPUDEFINES += -DUSE_THREADS -I${BUILDLINK_DIR}/include
+EXTRALIBS += -Wl,-R${LOCALBASE}/lib -L${BUILDLINK_DIR}/lib -lpthread
 endif
 
 ifdef GLIDE
@@ -206,7 +230,9 @@ $(AIDODEFINES) \
 $(KREEDDEFINES) \
 $(SDD1DEFINES) \
 $(JOYDEFINES) \
--DNO_INLINE_SET_GET @SYSDEFINES@
+$(USBJOYDEFINES) \
+$(DGADEFINES) \
+$(EXTRADEFINES)
 
 #-DOLD_COLOUR_BLENDING
 #-DSOUND
@@ -222,7 +248,7 @@ CFLAGS=$(CCFLAGS)
 
 .SUFFIXES: .o .cpp .c .cc .h .m .i .S .asm .obj .O .CPP .C .ASM
 #FIXME: Why is this set statically?
-#LDLIBS = -L/usr/X11R6/lib
+LDLIBS += -Wl,-R${X11BASE}/lib
 # -L../zlib
 
 ifdef GLIDE
@@ -262,7 +288,7 @@ offsets: offsets.o
 	./offsets >$(srcdir)/$(CPU)/offsets.h #FIXME: Move to builddir
 
 snes9x: $(OBJECTS) unix/x11.o $(AIDOOBJS)
-	$(CCC) $(INCLUDES) -o $@ $(OBJECTS) $(AIDOOBJS) $(GLIDEOBJS) $(OPENGLOBJS) unix/x11.o $(LDLIBS) $(GLIDELIBS) $(OPENGLLIBS) @SYSLIBS@ -lXext -lX11 $(EXTRALIBS) -lm
+	$(CCC) $(INCLUDES) -o $@ $(OBJECTS) $(AIDOOBJS) $(GLIDEOBJS) $(OPENGLOBJS) unix/x11.o $(LDLIBS) $(GLIDELIBS) $(OPENGLLIBS) @SYSLIBS@ -lXext -lX11 $(EXTRALIBS) $(DGALIBS) -lm
 
 ssnes9x: $(OBJECTS) unix/svga.o 
 	$(CCC) $(INCLUDES) -o $@ $(OBJECTS) $(GLIDEOBJS) unix/svga.o $(LDLIBS) $(GLIDELIBS) @SYSLIBS@ -lvga -lvgagl $(EXTRALIBS) -lm
@@ -302,7 +328,7 @@ s9xserver: $(SERVER_OBJECTS)
 	sh-elf-as -little $(srcdir)/$*.s -o $@
 
 .asm.o:
-	$(NASM) -f elf $(FXDEFINES) -I$(srcdir)/ -I$(srcdir)/$(CPU)/ -o $@ $(srcdir)/$*.asm
+	$(NASM) -f ${FILEFORMAT} $(FXDEFINES) $(EXTRADEFINES) -I$(srcdir)/ -I$(srcdir)/$(CPU)/ -o $@ $(srcdir)/$*.asm
 
 .obj.o:
 	cp $*.obj $*.o
