# $NetBSD: Makefile,v 1.1.1.1 2003/12/04 16:06:32 xtraeme Exp $

DISTNAME=		sarg-2.0.9
CATEGORIES=		www
MASTER_SITES=		${MASTER_SITE_SOURCEFORGE:=sarg/}

MAINTAINER=		mishka@apk.od.ua
HOMEPAGE=		http://sarg.sourceforge.net/sarg.php
COMMENT=		Squid-Cache proxy server Analysis Report Generator

AUTOCONF_REQD+=		2.56
GNU_CONFIGURE=		yes
USE_TOOLS+=		autoconf
CONFIGURE_ARGS+=	--enable-bindir=${PREFIX}/sbin			\
			--enable-mandir=${PREFIX}/${PKGMANDIR}/man1	\
			--enable-sysconfdir=${DATADIR:Q}		\
			--enable-htmldir=${SARG_REPORTSDIR:Q}

DIST_SUBDIR=		${DISTNAME}
PKG_SYSCONFSUBDIR=	sarg
EGDIR=			${PREFIX}/share/examples/sarg
DATADIR=		${PREFIX}/share/sarg

SARG_REPORTSDIR?=	${VARBASE}/sarg
SG_LOG?=		${VARBASE}/squidguard/log/squidGuard.log
SQUID_ACCESSLOG?=	${VARBASE}/squid/logs/access.log

BUILD_DEFS+=		SARG_REPORTSDIR SG_LOG SQUID_ACCESSLOG

PKG_OPTIONS_VAR=	PKG_OPTIONS.sarg
PKG_SUPPORTED_OPTIONS=	gd
.include "../../mk/bsd.options.mk"

.if !empty(PKG_OPTIONS:Mgd)
.  include "../../graphics/gd/buildlink3.mk"
.endif

FILES_SUBST+=		SARG_REPORTSDIR=${SARG_REPORTSDIR:Q}		\
			SG_LOG=${SG_LOG:Q}				\
			SQUID_ACCESSLOG=${SQUID_ACCESSLOG:Q}
SUBST_CLASSES+=		sargconf sargsrc
SUBST_MESSAGE.sargconf=	[Adjust values in SARG configuration files]
SUBST_MESSAGE.sargsrc=	[Adjust values in SARG sources]
SUBST_STAGE.sargconf=	pre-configure
SUBST_STAGE.sargsrc=	pre-configure
SUBST_FILES.sargconf=	htaccess sarg.1 sarg.conf
SUBST_FILES.sargsrc=	convlog.c splitlog.c log.c usage.c
SUBST_SED.sargconf=	${FILES_SUBST_SED}
SUBST_SED.sargsrc=	${FILES_SUBST_SED}

OWN_DIRS+=		${SARG_REPORTSDIR}

CONF_FILES=		${EGDIR}/sarg.conf ${PKG_SYSCONFDIR}/sarg.conf	\
			${EGDIR}/css.tpl ${PKG_SYSCONFDIR}/css.tpl	\
			${EGDIR}/exclude_codes ${PKG_SYSCONFDIR}/exclude_codes

post-extract:
		@${FIND} ${WRKSRC} -type d -exec ${CHMOD} +x {} \;
		@${RM} ${WRKSRC}/languages/.new

pre-configure:
		cd ${WRKSRC} && autoconf

do-install:
		${INSTALL_PROGRAM} ${WRKSRC}/sarg ${PREFIX}/sbin
		${INSTALL_MAN} ${WRKSRC}/sarg.1 ${PREFIX}/${PKGMANDIR}/man1
		${INSTALL_DATA_DIR} ${EGDIR}
		${INSTALL_DATA_DIR} ${DATADIR}/fonts
		${INSTALL_DATA_DIR} ${DATADIR}/images
		${INSTALL_DATA_DIR} ${DATADIR}/languages
		${INSTALL_DATA} ${WRKSRC}/sarg.conf ${EGDIR}
		${INSTALL_DATA} ${WRKSRC}/exclude_codes ${EGDIR}
		${INSTALL_DATA} ${WRKSRC}/css.tpl ${EGDIR}
		${INSTALL_DATA} ${WRKSRC}/fonts/FreeSans.ttf ${DATADIR}/fonts
		${INSTALL_DATA} ${WRKSRC}/images/* ${DATADIR}/images
		${INSTALL_DATA} ${WRKSRC}/languages/* ${DATADIR}/languages

.include "../../mk/bsd.pkg.mk"
