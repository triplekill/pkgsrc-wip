#! @SH@
#
# $Id$
# 
# TODOs:
# - Handle a signals to remove temporary files.
# - Use the standard paths to DISTDIR and PKGSRCDIR (?)
# - Escape from incompatibility for "-r" and "-l" flags.
# - Handle various source lists with "-D distfiles_list" and
#   "-P pkgsrcfiles_list".
# - Implement "-f file_filestoremove_list" to fetch list of files to
#   remove form some file.
# - Implement "-i" flag which should be used for interactive deletions.
# - Create man page.

usage ()
{
	echo 'Clean up pkgsrc/distfiles directory. V0.1 ($Revision$)'
	echo 'Usage: pkg_distclean [options]'
	echo '  where options are as follows:'
	echo '  -d <DISTDIR>    set DESTDIR to <DESTDIR>'
	echo '  -p <PKGSRCDIR>  set PKGSRCDIR to <PKGSRCDIR>'
	echo '  -r              remove unknown files in DESTDIR'
	echo '  -l              show detailed info for each old file'
	echo '  -i              request confirmation on each file removed [N/A]'
	echo '  -v              be verbose'
	echo '  -h              this help message'
	echo 'Please note the "-l" and "-r" flags are mutually exclusive.'
}

# Remove extra characters in list of files.
# usage: _detox [filename]
_detox ()
{
	${SED} 's:^\./::' $1 | ${SORT} -u
}

VERBOSE=${VERBOSE:-0}

PREFIX=${PREFIX:-@PREFIX@}
DISTDIR=${DISTDIR:-@DISTDIR@}
PKGSRCDIR=${PKGSRCDIR:-@_PKGSRCDIR@}
TMPDIR=${TMPDIR:-/tmp}

CAT=${CAT:-@CAT@}
DIFF=${DIFF:-@DIFF@}
ECHO=${ECHO:-@ECHO@}
FIND=${FIND:-@FIND@}
GREP=${GREP:-@GREP@}
LS=${LS:-@LS@}
MAKE=${MAKE:-@MAKE@}
RM=${RM:-@RM@}
SED=${SED:-@SED@}
SORT=${SORT:-@SORT@}
XARGS=${XARGS:-@XARGS@}

CLEAN_CMD=${CAT}

PATH=/sbin:/usr/sbin:/bin:/usr/bin:${PREFIX}/sbin:${PREFIX}/bin:@PKG_TOOLS_BIN@
export PATH

SHOWN_DISTFILES_FILE=${TMPDIR}/pkgcleandir-shown.$$
EXISTENT_DISTFILES_FILE=${TMPDIR}/pkgcleandir-existent.$$
DIFF_FILE=${TMPDIR}/pkgcleandir-diff.$$
TEMP_FILE=${TMPDIR}/pkgcleandir-temp.$$

while [ $# -ne 0 ]
do
	# See usage() for comments
	case $1 in
	-d)
		shift
		DISTDIR=$1
		shift
		;;
	-p)
		shift
		PKGSRCDIR=$1
		shift
		;;
	-l)
		CLEAN_CMD="${XARGS} ${LS} -l"
		shift
		;;
	-r)
		CLEAN_CMD="${XARGS} ${RM} -f"
		shift
		;;
	-v)
		VERBOSE=1
		shift
		;;
	-h|*)
		usage 1>&2
		exit 1
		;;
	esac
done

if [ ! -d ${PKGSRCDIR} -o ! -r ${PKGSRCDIR} ] ; then
	${ECHO} "$0: the PKGSRCDIR directory is not accessible. Giving up." 1>&2
	exit 1
fi
if [ ! -d ${DISTDIR} -o ! -r ${DISTDIR} ] ; then
	${ECHO} "$0: the DISTDIR directory is not accessible. Giving up." 1>&2
	exit 1
fi


[ ${VERBOSE} -eq 1 ] && ${ECHO} \
"I.   Obtaining a list of actually needed files. This can take a while." 1>&2
cd ${PKGSRCDIR} && ${MAKE} show-distfiles > ${TEMP_FILE}
if [ $? -ne 0 ] ; then
	${ECHO} "$0: exit due to errors (see above)."
	exit 1
fi
_detox ${TEMP_FILE} > ${SHOWN_DISTFILES_FILE}

[ ${VERBOSE} -eq 1 ] && ${ECHO} \
"II.  Obtain a list of already existent files." 1>&2
cd ${DISTDIR} && ${FIND} . -type f -print > ${TEMP_FILE}
if [ $? -ne 0 ] ; then
	${ECHO} "$0: exit due to errors (see above)."
	exit 1
fi
_detox ${TEMP_FILE} > ${EXISTENT_DISTFILES_FILE}

[ ${VERBOSE} -eq 1 ] && ${ECHO} \
"III. Building differences." 1>&2
${DIFF} -u ${EXISTENT_DISTFILES_FILE} ${SHOWN_DISTFILES_FILE} \
	| ${GREP} -v \
		-e "--- ${EXISTENT_DISTFILES_FILE}" \
		-e "+++ ${SHOWN_DISTFILES_FILE}" \
	> ${DIFF_FILE}

[ ${VERBOSE} -eq 1 ] && ${ECHO} \

"IV.  Clean up ${DISTDIR}." 1>&2
cd ${DISTDIR} && ${SED} -n 's/^-//p' ${DIFF_FILE} | ${CLEAN_CMD}

[ ${VERBOSE} -eq 1 ] && ${ECHO} \
"V.   Remove temporary files." 1>&2
${RM} -f ${TEMP_FILE}
${RM} -f ${SHOWN_DISTFILES_FILE} ${EXISTENT_DISTFILES_FILE}
