$NetBSD$

--- upnp/src/genlib/net/uri/uri.c.orig	2007-04-28 21:02:33.000000000 +0900
+++ upnp/src/genlib/net/uri/uri.c
@@ -41,6 +41,7 @@
 #endif
 #include "config.h"
 #include "uri.h"
+#include <pthread.h>
 
 #ifdef WIN32
  #include "inet_pton.h"
@@ -618,7 +619,7 @@ parse_hostport( const char *in,
         // platform-specific stuff below
 #if defined(WIN32) || defined(__CYGWIN__)
         h=gethostbyname(temp_host_name);
-#elif defined(SPARC_SOLARIS)
+#elif defined(sun)
         errCode = gethostbyname_r( temp_host_name,
                                    &h,
                                    temp_hostbyname_buff,
@@ -631,11 +632,30 @@ parse_hostport( const char *in,
         if ( h == NULL ) {
             errCode = 1;
         }
-#else
+#elif defined(linux)
         errCode = gethostbyname_r( temp_host_name,
                                    &h_buf,
                                    temp_hostbyname_buff,
                                    BUFFER_SIZE, &h, &errcode );
+#elif defined(__osf1__)
+        h = gethostbyname( temp_host_name );
+	errCode = h = NULL ? -1 : 0;
+#elif defined(__hpux) || defined(_AIX)
+        errCode = gethostbyname_r( temp_host_name,
+                                   &h_buf,
+                                   (struct hostent_data*)temp_hostbyname_buff);
+        h = &h_buf;
+#else
+        struct hostent *h2;
+        static pthread_mutex_t hostname_mutex = PTHREAD_MUTEX_INITIALIZER;
+        pthread_mutex_lock( &hostname_mutex );
+        if (( h2 = gethostbyname( temp_host_name)) == NULL) {
+             errCode = -1;
+        } else {
+             memcpy(&h_buf, h2, sizeof(struct hostent));
+             h = &h_buf;
+        }
+        pthread_mutex_unlock(&hostname_mutex);
 #endif 
 
         if( errCode == 0 ) {
