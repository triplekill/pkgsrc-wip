$NetBSD$

--- upnp/src/genlib/net/uri/uri.c.orig	2007-04-28 12:02:33.000000000 +0000
+++ upnp/src/genlib/net/uri/uri.c
@@ -41,6 +41,7 @@
 #endif
 #include "config.h"
 #include "uri.h"
+#include <pthread.h>
 
 #ifdef WIN32
  #include "inet_pton.h"
@@ -616,9 +617,9 @@ parse_hostport( const char *in,
         //call gethostbyname_r (reentrant form of gethostbyname)
         // TODO: Use autoconf to discover this rather than the
         // platform-specific stuff below
-#if defined(WIN32) || defined(__CYGWIN__)
+#if defined(WIN32) || defined(__CYGWIN__) || defined(_AIX50) || defined(__upux11)
         h=gethostbyname(temp_host_name);
-#elif defined(SPARC_SOLARIS)
+#elif defined(sun) || defined(__sun) || defined(sgi) || defined(__sgi)
         errCode = gethostbyname_r( temp_host_name,
                                    &h,
                                    temp_hostbyname_buff,
@@ -631,11 +632,27 @@ parse_hostport( const char *in,
         if ( h == NULL ) {
             errCode = 1;
         }
-#else
+#elif defined(__GLIBC__)
         errCode = gethostbyname_r( temp_host_name,
                                    &h_buf,
                                    temp_hostbyname_buff,
                                    BUFFER_SIZE, &h, &errcode );
+#elif defined(__osf1__) || defined(__hpux) || defined(_AIX)
+        errCode = gethostbyname_r( temp_host_name,
+                                   &h_buf,
+                                   (struct hostent_data*)temp_hostbyname_buff);
+        h = &h_buf;
+#else
+        struct hostent *h2;
+        static pthread_mutex_t hostname_mutex = PTHREAD_MUTEX_INITIALIZER;
+        pthread_mutex_lock( &hostname_mutex );
+        if (( h2 = gethostbyname( temp_host_name)) == NULL) {
+             errCode = -1;
+        } else {
+             memcpy(&h_buf, h2, sizeof(struct hostent));
+             h = &h_buf;
+        }
+        pthread_mutex_unlock(&hostname_mutex);
 #endif 
 
         if( errCode == 0 ) {
