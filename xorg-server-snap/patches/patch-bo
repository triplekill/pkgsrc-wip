$NetBSD$

--- hw/xfree86/dri/dri.c.orig	2006-11-30 20:40:10.000000000 -0500
+++ hw/xfree86/dri/dri.c
@@ -123,12 +123,6 @@ DRIScreenInit(ScreenPtr pScreen, DRIInfo
     drmVersionPtr       drmlibv;
     int                 drmlibmajor, drmlibminor, drmdimajor, drmdiminor;
 
-    if (DRIGeneration != serverGeneration) {
-	if ((DRIScreenPrivIndex = AllocateScreenPrivateIndex()) < 0)
-	    return FALSE;
-	DRIGeneration = serverGeneration;
-    }
-
     /* If the DRI extension is disabled, do not initialize the DRI */
     if (noXFree86DRIExtension) {
 	DRIDrvMsg(pScreen->myNum, X_WARNING,
@@ -193,9 +187,16 @@ DRIScreenInit(ScreenPtr pScreen, DRIInfo
                  pDRIInfo->drmDriverName);
     }
 
+    if (DRIGeneration != serverGeneration) {
+	if ((DRIScreenPrivIndex = AllocateScreenPrivateIndex()) < 0)
+	    return FALSE;
+	DRIGeneration = serverGeneration;
+    }
+
     pDRIPriv = (DRIScreenPrivPtr) xcalloc(1, sizeof(DRIScreenPrivRec));
     if (!pDRIPriv) {
         pScreen->devPrivates[DRIScreenPrivIndex].ptr = NULL;
+        DRIScreenPrivIndex = -1;
         return FALSE;
     }
 
@@ -488,7 +489,7 @@ DRICloseScreen(ScreenPtr pScreen)
     drm_context_t *    reserved;
     int              reserved_count;
 
-    if (pDRIPriv && pDRIPriv->directRenderingSupport) {
+    if (pDRIPriv) {
 
         pDRIInfo = pDRIPriv->pDriverInfo;
 
@@ -574,6 +575,7 @@ DRICloseScreen(ScreenPtr pScreen)
 
 	xfree(pDRIPriv);
 	pScreen->devPrivates[DRIScreenPrivIndex].ptr = NULL;
+	DRIScreenPrivIndex = -1;
     }
 }
 
@@ -1276,13 +1278,18 @@ DRIGetDrawableInfo(ScreenPtr pScreen,
 	       if (x1 > pScreen->width) x1 = pScreen->width;
 	       if (y1 > pScreen->height) y1 = pScreen->height;
 
-	       pDRIPriv->private_buffer_rect.x1 = x0;
-	       pDRIPriv->private_buffer_rect.y1 = y0;
-	       pDRIPriv->private_buffer_rect.x2 = x1;
-	       pDRIPriv->private_buffer_rect.y2 = y1;
-
-	       *numBackClipRects = 1;
-	       *pBackClipRects = &(pDRIPriv->private_buffer_rect);
+	       if (y0 >= y1 || x0 >= x1) {
+		    *numBackClipRects = 0;
+		    *pBackClipRects = NULL;
+	       } else {
+		    pDRIPriv->private_buffer_rect.x1 = x0;
+		    pDRIPriv->private_buffer_rect.y1 = y0;
+		    pDRIPriv->private_buffer_rect.x2 = x1;
+		    pDRIPriv->private_buffer_rect.y2 = y1;
+
+		    *numBackClipRects = 1;
+		    *pBackClipRects = &(pDRIPriv->private_buffer_rect);
+	       }
 	    } else {
 	       /* Use the frontbuffer cliprects for back buffers.  */
 	       *numBackClipRects = 0;
@@ -1603,8 +1610,12 @@ DRIWindowExposures(WindowPtr pWin, Regio
 	/* unwrap */
 	pScreen->WindowExposures = pDRIPriv->wrap.WindowExposures;
 
+	DRILock(pScreen, 0);
+
 	/* call lower layers */
 	(*pScreen->WindowExposures)(pWin, prgn, bsreg);
+	
+	DRIUnlock(pScreen);
 
 	/* rewrap */
 	pDRIPriv->wrap.WindowExposures = pScreen->WindowExposures;
